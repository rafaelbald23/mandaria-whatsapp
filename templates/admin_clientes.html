<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar Clientes - MandarIA</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
    <link rel="icon" href="{{ url_for('static', filename='images/monitoria-logo.png') }}" type="image/png">
    <style>
        .admin-container {
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .admin-header h1 {
            font-size: 2rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .btn-adicionar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-adicionar:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .clientes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .cliente-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 1.5rem;
            transition: all 0.3s;
        }

        .cliente-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.2);
        }

        .cliente-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }

        .cliente-nome {
            font-size: 1.2rem;
            font-weight: 600;
            color: white;
        }

        .cliente-usuario {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 0.2rem;
        }

        .status-badge {
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-ativo {
            background: rgba(46, 213, 115, 0.2);
            color: #2ed573;
        }

        .status-inativo {
            background: rgba(255, 71, 87, 0.2);
            color: #ff4757;
        }

        .status-bloqueado {
            background: rgba(255, 159, 67, 0.2);
            color: #ff9f43;
        }

        .cliente-info {
            margin: 1rem 0;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .cliente-info div {
            margin: 0.5rem 0;
        }

        .cliente-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-top: 1rem;
        }

        .btn-action {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.3s;
            flex: 1;
            min-width: 100px;
        }

        .btn-editar {
            background: rgba(102, 126, 234, 0.2);
            color: #667eea;
        }

        .btn-editar:hover {
            background: rgba(102, 126, 234, 0.3);
        }

        .btn-ativar {
            background: rgba(46, 213, 115, 0.2);
            color: #2ed573;
        }

        .btn-ativar:hover {
            background: rgba(46, 213, 115, 0.3);
        }

        .btn-desativar {
            background: rgba(255, 71, 87, 0.2);
            color: #ff4757;
        }

        .btn-desativar:hover {
            background: rgba(255, 71, 87, 0.3);
        }

        .btn-bloquear {
            background: rgba(255, 159, 67, 0.2);
            color: #ff9f43;
        }

        .btn-bloquear:hover {
            background: rgba(255, 159, 67, 0.3);
        }

        .btn-senha {
            background: rgba(87, 101, 116, 0.2);
            color: #a4b0be;
        }

        .btn-senha:hover {
            background: rgba(87, 101, 116, 0.3);
        }

        .btn-remover {
            background: rgba(255, 71, 87, 0.2);
            color: #ff4757;
        }

        .btn-remover:hover {
            background: rgba(255, 71, 87, 0.4);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: rgba(32, 29, 46, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-header h2 {
            font-size: 1.5rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .btn-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 600;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.8rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: white;
            font-size: 1rem;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .btn-submit {
            flex: 1;
            padding: 1rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
        }

        .btn-cancel {
            flex: 1;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 1.5rem;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stat-label {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 0.5rem;
        }
    </style>
</head>
<body>
    {% include 'partials/sidebar.html' %}

    <div class="main-content">
        <div class="admin-container">
            <div class="admin-header">
                <h1 style="display: flex; align-items: center; gap: 0.5rem;">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    Gerenciar Clientes
                </h1>
                <button class="btn-adicionar" onclick="abrirModalAdicionar()" style="display: flex; align-items: center; gap: 0.5rem;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    Adicionar Cliente
                </button>
            </div>

            <!-- Estatísticas -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="total-clientes">0</div>
                    <div class="stat-label">Total de Clientes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="clientes-ativos">0</div>
                    <div class="stat-label">Clientes Ativos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="clientes-bloqueados">0</div>
                    <div class="stat-label">Bloqueados</div>
                </div>
            </div>

            <!-- Grid de Clientes -->
            <div class="clientes-grid" id="clientes-grid">
                <!-- Clientes serão carregados aqui -->
            </div>
        </div>
    </div>

    <!-- Modal Adicionar Cliente -->
    <div class="modal" id="modal-adicionar">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Adicionar Novo Cliente</h2>
                <button class="btn-close" onclick="fecharModal('modal-adicionar')">×</button>
            </div>
            <form id="form-adicionar" onsubmit="adicionarCliente(event)">
                <div class="form-group">
                    <label>Usuário (Login) *</label>
                    <input type="text" name="usuario" required>
                </div>
                <div class="form-group">
                    <label>Senha *</label>
                    <input type="password" name="senha" required>
                </div>
                <div class="form-group">
                    <label>Nome Completo *</label>
                    <input type="text" name="nome_completo" required>
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" name="email">
                </div>
                <div class="form-group">
                    <label>Empresa</label>
                    <input type="text" name="empresa">
                </div>
                <div class="form-group">
                    <label>Telefone</label>
                    <input type="text" name="telefone">
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn-submit">Adicionar</button>
                    <button type="button" class="btn-cancel" onclick="fecharModal('modal-adicionar')">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Alterar Senha -->
    <div class="modal" id="modal-senha">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Alterar Senha</h2>
                <button class="btn-close" onclick="fecharModal('modal-senha')">×</button>
            </div>
            <form id="form-senha" onsubmit="alterarSenha(event)">
                <input type="hidden" name="usuario" id="senha-usuario">
                <div class="form-group">
                    <label>Nova Senha</label>
                    <input type="password" name="senha_nova" required>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn-submit">Alterar</button>
                    <button type="button" class="btn-cancel" onclick="fecharModal('modal-senha')">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        let clientes = [];

        // Carrega clientes ao iniciar
        document.addEventListener('DOMContentLoaded', () => {
            carregarClientes();
        });

        async function carregarClientes() {
            try {
                const response = await fetch('/api/admin/clientes');
                const data = await response.json();
                
                if (data.success) {
                    clientes = data.clientes;
                    renderizarClientes();
                    atualizarEstatisticas();
                }
            } catch (error) {
                console.error('Erro ao carregar clientes:', error);
            }
        }

        function renderizarClientes() {
            const grid = document.getElementById('clientes-grid');
            
            if (clientes.length === 0) {
                grid.innerHTML = '<p style="color: rgba(255,255,255,0.6); text-align: center; grid-column: 1/-1;">Nenhum cliente cadastrado</p>';
                return;
            }

            grid.innerHTML = clientes.map(cliente => {
                const statusClass = cliente.bloqueado ? 'status-bloqueado' : (cliente.ativo ? 'status-ativo' : 'status-inativo');
                const statusText = cliente.bloqueado ? 'Bloqueado' : (cliente.ativo ? 'Ativo' : 'Inativo');
                
                return `
                    <div class="cliente-card">
                        <div class="cliente-header">
                            <div>
                                <div class="cliente-nome">${cliente.nome_completo}</div>
                                <div class="cliente-usuario">@${cliente.usuario}</div>
                            </div>
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </div>
                        
                        <div class="cliente-info">
                            ${cliente.email ? `<div style="display: flex; align-items: center; gap: 0.5rem;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>${cliente.email}</div>` : ''}
                            ${cliente.empresa ? `<div style="display: flex; align-items: center; gap: 0.5rem;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path></svg>${cliente.empresa}</div>` : ''}
                            ${cliente.telefone ? `<div style="display: flex; align-items: center; gap: 0.5rem;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"></rect><line x1="12" y1="18" x2="12.01" y2="18"></line></svg>${cliente.telefone}</div>` : ''}
                            <div style="display: flex; align-items: center; gap: 0.5rem;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>${cliente.total_envios || 0} envios</div>
                            ${cliente.ultimo_acesso ? `<div style="display: flex; align-items: center; gap: 0.5rem;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>Último acesso: ${formatarData(cliente.ultimo_acesso)}</div>` : ''}
                        </div>
                        
                        <div class="cliente-actions">
                            ${cliente.ativo && !cliente.bloqueado ? 
                                `<button class="btn-action btn-desativar" onclick="desativarCliente('${cliente.usuario}')">Desativar</button>` :
                                `<button class="btn-action btn-ativar" onclick="ativarCliente('${cliente.usuario}')">Ativar</button>`
                            }
                            ${cliente.bloqueado ?
                                `<button class="btn-action btn-ativar" onclick="desbloquearCliente('${cliente.usuario}')">Desbloquear</button>` :
                                `<button class="btn-action btn-bloquear" onclick="bloquearCliente('${cliente.usuario}')">Bloquear</button>`
                            }
                            <button class="btn-action btn-senha" onclick="abrirModalSenha('${cliente.usuario}')">Senha</button>
                            <button class="btn-action btn-remover" onclick="removerCliente('${cliente.usuario}', '${cliente.nome_completo}')">Remover</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function atualizarEstatisticas() {
            const total = clientes.length;
            const ativos = clientes.filter(c => c.ativo && !c.bloqueado).length;
            const bloqueados = clientes.filter(c => c.bloqueado).length;

            document.getElementById('total-clientes').textContent = total;
            document.getElementById('clientes-ativos').textContent = ativos;
            document.getElementById('clientes-bloqueados').textContent = bloqueados;
        }

        function formatarData(isoString) {
            const data = new Date(isoString);
            return data.toLocaleString('pt-BR', { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function abrirModalAdicionar() {
            document.getElementById('modal-adicionar').classList.add('active');
        }

        function abrirModalSenha(usuario) {
            document.getElementById('senha-usuario').value = usuario;
            document.getElementById('modal-senha').classList.add('active');
        }

        function fecharModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        async function adicionarCliente(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData);
            
            try {
                const response = await fetch('/api/admin/clientes/adicionar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Cliente adicionado com sucesso!');
                    fecharModal('modal-adicionar');
                    event.target.reset();
                    carregarClientes();
                } else {
                    alert(result.message);
                }
            } catch (error) {
                alert('Erro ao adicionar cliente');
                console.error(error);
            }
        }

        async function alterarSenha(event) {
            event.preventDefault();
            
            const usuario = document.getElementById('senha-usuario').value;
            const senha_nova = event.target.senha_nova.value;
            
            try {
                const response = await fetch(`/api/admin/clientes/${usuario}/alterar-senha`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ senha_nova })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Senha alterada com sucesso!');
                    fecharModal('modal-senha');
                    event.target.reset();
                } else {
                    alert(result.message);
                }
            } catch (error) {
                alert('Erro ao alterar senha');
                console.error(error);
            }
        }

        async function ativarCliente(usuario) {
            if (!confirm('Deseja ativar este cliente?')) return;
            
            try {
                const response = await fetch(`/api/admin/clientes/${usuario}/ativar`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Cliente ativado!');
                    carregarClientes();
                } else {
                    alert(result.message);
                }
            } catch (error) {
                alert('Erro ao ativar cliente');
                console.error(error);
            }
        }

        async function desativarCliente(usuario) {
            if (!confirm('Deseja desativar este cliente?')) return;
            
            try {
                const response = await fetch(`/api/admin/clientes/${usuario}/desativar`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Cliente desativado!');
                    carregarClientes();
                } else {
                    alert(result.message);
                }
            } catch (error) {
                alert('Erro ao desativar cliente');
                console.error(error);
            }
        }

        async function bloquearCliente(usuario) {
            if (!confirm('Deseja bloquear este cliente por falta de pagamento?')) return;
            
            try {
                const response = await fetch(`/api/admin/clientes/${usuario}/bloquear`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Cliente bloqueado!');
                    carregarClientes();
                } else {
                    alert(result.message);
                }
            } catch (error) {
                alert('Erro ao bloquear cliente');
                console.error(error);
            }
        }

        async function desbloquearCliente(usuario) {
            if (!confirm('Deseja desbloquear este cliente?')) return;
            
            try {
                const response = await fetch(`/api/admin/clientes/${usuario}/desbloquear`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Cliente desbloqueado!');
                    carregarClientes();
                } else {
                    alert(result.message);
                }
            } catch (error) {
                alert('Erro ao desbloquear cliente');
                console.error(error);
            }
        }

        async function removerCliente(usuario, nome) {
            if (!confirm(`Deseja realmente remover o cliente "${nome}"?\n\nEsta ação não pode ser desfeita!`)) return;
            
            try {
                const response = await fetch(`/api/admin/clientes/${usuario}/remover`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Cliente removido!');
                    carregarClientes();
                } else {
                    alert(result.message);
                }
            } catch (error) {
                alert('Erro ao remover cliente');
                console.error(error);
            }
        }
    </script>
</body>
</html>
